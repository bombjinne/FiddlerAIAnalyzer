<UserControl x:Class="FiddlerAIAnalyzerPlugin.AIChatView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="White"
             HorizontalAlignment="Stretch"
             VerticalAlignment="Stretch">
    <Grid Margin="5">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <!-- 内容选择区 -->
            <RowDefinition Height="*"/>
            <!-- 聊天区 -->
            <RowDefinition Height="Auto"/>
            <!-- 输入区 -->
        </Grid.RowDefinitions>

        <!-- ====== API Key 行 ====== -->
        <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="0,0,0,5">
            <TextBlock Text="🔑 QWEN API Key:" VerticalAlignment="Center" FontSize="12"/>
            <PasswordBox x:Name="ApiKeyBox" Width="180" Margin="5,0" BorderThickness="1" BorderBrush="#ccc"/>
            <Button Content="保存" Width="60" Margin="5,0" Click="OnSaveApiKeyClick" Background="#007acc" Foreground="White"/>
        </StackPanel>

        <!-- ====== 内容选择区 ====== -->
        <GroupBox Header="📤 发送给 AI 的内容" Grid.Row="1" Margin="0,0,0,5">
            <WrapPanel HorizontalAlignment="Left" Margin="5">
                <CheckBox x:Name="CbUrl" Content="URL" IsChecked="True" Margin="5"/>
                <CheckBox x:Name="CbReqHeaders" Content="请求头" IsChecked="True" Margin="5"/>
                <CheckBox x:Name="CbReqBody" Content="请求体" IsChecked="True" Margin="5"/>
                <CheckBox x:Name="CbRespHeaders" Content="响应头" IsChecked="True" Margin="5"/>
                <CheckBox x:Name="CbRespBody" Content="响应体" IsChecked="True" Margin="5"/>
                <CheckBox x:Name="CbNoBinary" Content="❌ 不发送二进制内容（如图片、音频、视频）" IsChecked="True" Margin="5"/>
            </WrapPanel>
        </GroupBox>

        <!-- ====== 聊天历史区 ====== -->
        <!-- ✅ 修改为 RichTextBox 以支持复制 -->
        <RichTextBox 
     x:Name="MessagesRichTextBox"
     Grid.Row="2"
     IsReadOnly="True"
     Background="Transparent" 
            BorderThickness="0"
            Padding="10"
            FontSize="12"
     Foreground="Black"
     Margin="0,0,0,5"
     HorizontalAlignment="Stretch"
     VerticalScrollBarVisibility="Auto">
            <FlowDocument>
                <!-- 可以保留初始空段落，也可以移除 -->
                <Paragraph/>
            </FlowDocument>
        </RichTextBox>

        <!-- ====== 输入区 ====== -->
        <Grid Grid.Row="3" Margin="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <!-- ✅ 为 TextBox 添加 KeyDown 事件 -->
            <TextBox x:Name="InputBox"
                     AcceptsReturn="True"
                     TextWrapping="Wrap"
                     MinHeight="40"
                     MaxHeight="120"
                     Padding="8"
                     VerticalContentAlignment="Top"
                     BorderBrush="#ccc"
                     HorizontalAlignment="Stretch"
                     VerticalAlignment="Center"
                     Grid.Column="0"
                     KeyDown="InputBox_KeyDown"/>
            <!-- 新增 -->

            <!-- 发送按钮：高度与 TextBox 一致 -->
            <Button Grid.Column="1"
                    Content="发送"
                    Width="70"
                    Margin="5,0,0,0"
                    Background="#007acc"
                    Foreground="White"
                    Click="OnSendButtonClick"
                    VerticalAlignment="Center"
                    Height="{Binding ElementName=InputBox, Path=ActualHeight}"
                    HorizontalAlignment="Center"
                    Padding="8,0"/>
        </Grid>
    </Grid>
</UserControl>